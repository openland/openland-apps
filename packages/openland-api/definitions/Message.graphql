fragment SpanFragment on MessageSpan {
    offset
    length

    ... on MessageSpanUserMention {
        user {
            ...UserForMention
        }
    }
    ... on MessageSpanMultiUserMention {
        users {
            ...UserForMention
        }
    }
    ... on MessageSpanOrganizationMention {
        organization {
            ...OrganizationShort
        }
    }
    ... on MessageSpanRoomMention {
        room {
            ...RoomNano
        }
    }
    ... on MessageSpanLink {
        url
    }
    ... on MessageSpanDate {
        date
    }
}

fragment TinyMessage on ModernMessage {
    id
    date
    sender {
        ...UserTiny
    }
    senderBadge {
        ...UserBadge
    }
    message
    fallback
    ... on GeneralMessage {
        id
        overrideName
        overrideAvatar {
            uuid
            crop {
                x
                y
                w
                h
            }
        }
        isMentioned
        commentsCount
        attachments {
            id
            fallback
            ... on MessageAttachmentFile {
                id
                fileId
                fileMetadata {
                    isImage
                    imageFormat
                }
                filePreview
            }
        }
        quotedMessages {
            id
        }
    }
}
fragment QuotedMessage on ModernMessage {
    id
    date
    message
    sender {
        ...UserShort
    }
    senderBadge {
        ...UserBadge
    }
    message
    fallback
    source {
        ... on MessageSourceChat {
            chat {
                ... on PrivateRoom {
                    id
                }
                ... on SharedRoom {
                    id
                }
            }
        }
    }
    spans {
        ...SpanFragment
    }

    ... on GeneralMessage {
        id
        overrideName
        overrideAvatar {
            uuid
            crop {
                x
                y
                w
                h
            }
        }
        commentsCount
        edited
        attachments {
            fallback
            ... on MessageAttachmentFile {
                id
                fileId
                fileMetadata {
                    name
                    mimeType
                    size
                    isImage
                    imageWidth
                    imageHeight
                    imageFormat
                }
                filePreview
            }

            ... on MessageRichAttachment {
                id
                title
                subTitle
                titleLink
                titleLinkHostname
                text
                icon {
                    url
                    metadata {
                        name
                        mimeType
                        size
                        isImage
                        imageWidth
                        imageHeight
                        imageFormat
                    }
                }
                image {
                    url
                    metadata {
                        name
                        mimeType
                        size
                        isImage
                        imageWidth
                        imageHeight
                        imageFormat
                    }
                }
                keyboard {
                    buttons {
                        id
                        title
                        style
                        url
                    }
                }
                imageFallback {
                    photo
                    text
                }
                fallback
            }

            ... on MessageAttachmentPurchase {
                id
                purchase {
                    id
                    state
                    amount
                }
            }
        }
    }

    ... on StickerMessage {
        id
        date
        overrideName
        overrideAvatar {
            uuid
            crop {
                x
                y
                w
                h
            }
        }
        sender {
            ...UserShort
        }
        senderBadge {
            ...UserBadge
        }
        source {
            ... on MessageSourceChat {
                chat {
                    ... on PrivateRoom {
                        id
                    }
                    ... on SharedRoom {
                        id
                    }
                }
            }
        }
        reactions {
            user {
                ...UserShort
            }
            reaction
        }
        sticker {
            ... on ImageSticker {
                id
                pack {
                    ... on StickerPack {
                        id
                        title
                    }
                }
                image {
                    ... on ImageRef {
                        uuid
                    }
                }
            }
        }
    }
}

fragment FullMessage on ModernMessage {
    id
    date
    sender {
        ...UserShort
    }
    senderBadge {
        ...UserBadge
    }
    message
    fallback
    source {
        ... on MessageSourceChat {
            chat {
                ... on PrivateRoom {
                    id
                }
                ... on SharedRoom {
                    id
                    isChannel
                    membersCount
                }
            }
        }
    }
    ... on GeneralMessage {
        id
        overrideName
        overrideAvatar {
            uuid
            crop {
                x
                y
                w
                h
            }
        }
        edited
        commentsCount
        attachments {
            fallback
            ... on MessageAttachmentFile {
                id
                fileId
                fileMetadata {
                    name
                    mimeType
                    size
                    isImage
                    imageWidth
                    imageHeight
                    imageFormat
                }
                filePreview
            }

            ... on MessageRichAttachment {
                id
                title
                subTitle
                titleLink
                titleLinkHostname
                text
                icon {
                    url
                    metadata {
                        name
                        mimeType
                        size
                        isImage
                        imageWidth
                        imageHeight
                        imageFormat
                    }
                }
                image {
                    url
                    metadata {
                        name
                        mimeType
                        size
                        isImage
                        imageWidth
                        imageHeight
                        imageFormat
                    }
                }
                socialImage {
                    url
                    metadata {
                        name
                        mimeType
                        size
                        isImage
                        imageWidth
                        imageHeight
                        imageFormat
                    }
                }
                imageFallback {
                    photo
                    text
                }
                keyboard {
                    buttons {
                        id
                        title
                        style
                        url
                    }
                }
                fallback
            }
            ... on MessageAttachmentPurchase {
                id
                purchase {
                    id
                    state
                    amount
                }
            }
        }
        quotedMessages {
            ...QuotedMessage
        }

        reactions {
            user {
                ...UserShort
            }
            reaction
        }
    }

    spans {
        ...SpanFragment
    }

    ... on StickerMessage {
        id
        overrideName
        overrideAvatar {
            uuid
            crop {
                x
                y
                w
                h
            }
        }
        date
        commentsCount
        sender {
            ...UserShort
        }
        senderBadge {
            ...UserBadge
        }
        quotedMessages {
            ...QuotedMessage
        }
        reactions {
            user {
                ...UserShort
            }
            reaction
        }
        sticker {
            ...StickerFragment
        }
    }

    ... on ServiceMessage {
        id
        overrideName
        overrideAvatar {
            uuid
            crop {
                x
                y
                w
                h
            }
        }
        serviceMetadata {
            ... on InviteServiceMetadata {
                users {
                    ...UserTiny
                }
                invitedBy {
                    ...UserTiny
                }
            }

            ... on KickServiceMetadata {
                user {
                    ...UserTiny
                }
                kickedBy {
                    ...UserTiny
                }
            }

            ... on TitleChangeServiceMetadata {
                title
            }

            ... on PhotoChangeServiceMetadata {
                photo
            }

            ... on PostRespondServiceMetadata {
                respondType
            }
        }
    }
}
