fragment ChatNewMessageFragment on ModernMessage {
    id
    date
    seq
    sender {
        id
    }
    message
    fallback
}

query ChatNewReadLastRead($chatId: ID!) {
    message: lastReadedMessage(chatId: $chatId) {
        id
    }
}

query ChatNewGetMessage($id: ID!) {
    message(messageId: $id) {
        ...ChatNewMessageFragment
    }
}

query ChatNewLoadBefore($chatId: ID!, $before: ID!, $limit: Int!) {
    batch: gammaMessages(chatId: $chatId, first: $limit, before: $before) {
        messages {
            ...ChatNewMessageFragment
        }
        haveMoreBackward
    }
}

query ChatNewLoadAfter($chatId: ID!, $after: ID!, $limit: Int!) {
    batch: gammaMessages(chatId: $chatId, first: $limit, after: $after) {
        messages {
            ...ChatNewMessageFragment
        }
        haveMoreForward
    }
}

query ChatNewLoadLastMessage($chatId: ID!) {
    messages(chatId: $chatId, first: 1) {
        ...ChatNewMessageFragment
    }
}

query ChatNewHaveAccess($chatId: ID!) {
    haveAccessToChat(chatId: $chatId)
}

#
# Dialog Updates
#

query ChatNewDialogsState {
    state: dialogsState {
        state
    }
}

#
# Chat Updates
#

query ChatNewChatState($chatId: ID!) {
    state: conversationState(id: $chatId) {
        state
    }
}

fragment NewChatUpdateFragment on ChatUpdate {
    ... on ChatMessageReceived {
        message {
            ...ChatNewMessageFragment
        }
        repeatKey
    }
    ... on ChatMessageUpdated {
        message {
            ...ChatNewMessageFragment
        }
    }
    ... on ChatMessageDeleted {
        message {
            id
        }
    }
}

subscription NewChatUpdates($chatId: ID!, $state: String) {
    event: chatUpdates(chatId: $chatId, fromState: $state) {
        ... on ChatUpdateSingle {
            state
            update {
                ...NewChatUpdateFragment
            }
        }
        ... on ChatUpdateBatch {
            state
            updates {
                ...NewChatUpdateFragment
            }
        }
    }
}